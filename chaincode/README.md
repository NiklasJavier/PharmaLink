### **Chaincodes: Pharmalink**

**Rollen:** `behoerde`, `hersteller`, `grosshaendler`, `apotheke`
**Autorisierungsprinzip:** Rollenbasierte Zugriffskontrolle (RBAC) über X.509-Zertifikatsattribute (`role`).

Die Rollen und X.509-Zertifikatsattribute der Akteure werden durch das Skript
[`fabric_setup_test_consortium.sh`](../scripts/fabric_setup_test_consortium.sh) generiert.

Für die Interaktion über die Fabric CLI können die Umgebungsvariablen für jede Rolle
separat geladen werden, z.B. für einen Hersteller:
[`Bsp. Hersteller Env. Sourcen`](../scripts/roles/fabric_role_hersteller.sh)
(Dieser Pfad ist ein *Beispiel*, da ich die genaue Struktur Ihres `scripts/roles` Ordners nicht kenne.
Bitte passen Sie den Pfad an Ihr tatsächliches Verzeichnis an.)

Die detaillierte Implementierung der Chaincode-Funktionen finden Sie in der Datei
[`PharmaSupplyChainContract.java`](./pharmalink_chaincode_main/src/main/java/de/jklein/fabric/PharmaSupplyChainContract.java).

| Kategorie | Funktion             | Typ           | Zweck & Autorisierung                                                                                                                                                                                                                                                                                                                                                                                    | Beispielaufruf (JSON)                                                                                                                                                                                  |
| :-------- | :------------------- | :------------ | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Akteur**| `initCall`           | Schreiben     | Registriert den aufrufenden Akteur basierend auf seinen X.509-Zertifikatsattributen (`role`) und generiert eine eindeutige `actorId`. Gibt bestehende Daten zurück, falls der Akteur bereits registriert ist. **Autorisierung:** Die Rolle aus dem Client-Zertifikat muss einer gültigen Affiliation (`hersteller`, `grosshaendler`, `apotheke`, `behoerde`) entsprechen.         | `{"function":"initCall","Args":[]}`                                                                                                                                                           |
|           | `createActor`        | Schreiben     | Legt einen neuen Akteur im Ledger an. Dies ist für Akteure gedacht, die durch eine Behörde manuell registriert werden, da `initCall` nur minimale Stammdaten anlegt. **Autorisierung:** Nur `behoerde` ist berechtigt.                                                                                                                                                                               | `{"function":"createActor","Args":["apotheke-123","Sonnen-Apotheke","apotheke","info@sonnen-apotheke.de","Qm..."]}`                                                                           |
|           | `updateActor`        | Schreiben     | Aktualisiert die Bezeichnung, E-Mail und den IPFS-Link eines bestehenden Akteurs. **Autorisierung:** Der aufrufende Akteur muss entweder der Akteur selbst sein oder die Rolle `behoerde` innehaben.                                                                                                                                                                                                 | `{"function":"updateActor","Args":["apotheke-123","Sonnen-Apotheke Neu","new@sonnen-apotheke.de","QmNew..."]}`                                                                               |
|           | `updateActorIpfsLink`| Schreiben     | Aktualisiert ausschließlich den IPFS-Link eines Akteurs. **Autorisierung:** Nur der Akteur selbst, dessen ID aktualisiert wird, ist dazu berechtigt.                                                                                                                                                                                                                                                     | `{"function":"updateActorIpfsLink","Args":["apotheke-123...","QmUpdated..."]}`                                                                                                                |
|           | `deleteActor`        | Schreiben     | Löscht einen Akteur aus dem Ledger. **Autorisierung:** Nur die Rolle `behoerde` ist berechtigt.                                                                                                                                                                                                                                                                                                   | `{"function":"deleteActor","Args":["apotheke-123"]}`                                                                                                                                          |
|           | `queryActor`         | Abrufen       | Fragt die Daten eines Akteurs anhand seiner ID ab. Dies ist eine generische Abfrage.                                                                                                                                                                                                                                                                                                               | `{"function":"queryActor","Args":["apotheke-123"]}`                                                                                                                                           |
|           | `queryActorById`     | Abrufen       | Fragt die Daten eines Akteurs anhand seiner *generierten* Actor ID ab.                                                                                                                                                                                                                                                                                                                             | `{"function":"queryActorById","Args":["apotheke-123..."]}`                                                                                                                                    |
|           | `queryActorByEmail`  | Abrufen       | Fragt die Daten eines Akteurs anhand seiner E-Mail-Adresse ab. Für diese Abfrage wird ein CouchDB-Index benötigt.                                                                                                                                                                                                                                                                                      | `{"function":"queryActorByEmail","Args":["info@sonnen-apotheke.de"]}`                                                                                                                         |
|           | `queryActorsByRole`  | Abrufen       | Fragt alle Akteure ab, die einer bestimmten Rolle zugeordnet sind. Für diese Abfrage wird ein CouchDB-Index benötigt.                                                                                                                                                                                                                                                                                | `{"function":"queryActorsByRole","Args":["apotheke"]}`                                                                                                                                       |
|           | `queryAllActors`     | Abrufen       | Fragt alle im Ledger registrierten Akteure ab.                                                                                                                                                                                                                                                                                                                                                     | `{"function":"queryAllActors","Args":[]}`                                                                                                                                                     |
|           | `queryActorsByBezeichnung`| Abrufen    | Sucht Akteure anhand eines Teils ihrer Bezeichnung (case-insensitive, unter Verwendung eines regulären Ausdrucks). Für diese Abfrage wird ein CouchDB-Index benötigt.                                                                                                                                                                                                                                | `{"function":"queryActorsByBezeichnung","Args":["Sonnen-Apotheke"]}`                                                                                                                         |
| **Medikament**| `createMedikament`   | Schreiben     | Legt ein neues Medikament im Ledger an und weist ihm automatisch eine ID zu. **Autorisierung:** Nur Akteure mit der Rolle `hersteller` sind berechtigt.                                                                                                                                                                                                                                               | `{"function":"createMedikament","Args":["Aspirin 500mg","hash123","Qm..."]}`                                                                                                                  |
|           | `approveMedikament`  | Schreiben     | Setzt den Status eines Medikaments auf "freigegeben" oder "abgelehnt". Dieser Schritt ist entscheidend für die Weiterverarbeitung des Medikaments. **Autorisierung:** Nur Akteure mit der Rolle `behoerde` sind berechtigt.                                                                                                                                                                          | `{"function":"approveMedikament","Args":["MED-abc...","freigegeben"]}`                                                                                                                        |
|           | `updateMedikament`   | Schreiben     | Aktualisiert die Bezeichnung, den Infoblatt-Hash und den IPFS-Link eines Medikaments. **Autorisierung:** Nur der anlegende `hersteller` des Medikaments ist berechtigt.                                                                                                                                                                                                                                | `{"function":"updateMedikament","Args":["MED-abc...","Aspirin Forte","newhash","newQm..."]}`                                                                                                 |
|           | `addMedikamentTag`   | Schreiben     | Fügt einem Medikament einen rollenbasierten Tag hinzu. Dies kann zur Verfolgung von Qualitätsprüfungen oder internen Vermerken verwendet werden. **Autorisierung:** Nur der anlegende `hersteller` oder eine `behoerde` sind berechtigt.                                                                                                                                                             | `{"function":"addMedikamentTag","Args":["MED-abc...","Charge 2 geprüft"]}`                                                                                                                    |
|           | `deleteMedikament`   | Schreiben     | Löscht ein Medikament aus dem Ledger. **Autorisierung:** Eine `behoerde` ist immer berechtigt. Ein anlegender `hersteller` ist nur dann berechtigt, wenn der Status des Medikaments noch "angelegt" ist (d.h. noch nicht freigegeben oder abgelehnt).                                                                                                                                              | `{"function":"deleteMedikament","Args":["MED-abc..."]}`                                                                                                                                      |
|           | `deleteMedikamentIfNoUnits`| Schreiben | Löscht ein Medikament nur dann, wenn keine Einheiten (Units) mehr mit diesem Medikament verknüpft sind. Dies dient der Datenintegrität. **Autorisierung:** Eine `behoerde` ist immer berechtigt. Ein anlegender `hersteller` ist nur dann berechtigt, wenn der Status des Medikaments noch "angelegt" ist.                                                                                        | `{"function":"deleteMedikamentIfNoUnits","Args":["MED-abc..."]}`                                                                                                                             |
|           | `queryMedikamentById`| Abrufen       | Fragt die Daten eines Medikaments anhand seiner ID ab.                                                                                                                                                                                                                                                                                                                                             | `{"function":"queryMedikamentById","Args":["MED-abc..."]}`                                                                                                                                   |
|           | `queryMedikamenteByHerstellerId`| Abrufen| Fragt alle Medikamente ab, die von einem bestimmten Hersteller angelegt wurden. Für diese Abfrage wird ein CouchDB-Index benötigt.                                                                                                                                                                                                                                                             | `{"function":"queryMedikamenteByHerstellerId","Args":["hersteller-xyz..."]}`                                                                                                                 |
|           | `queryAllMedikamente`| Abrufen       | Fragt alle im Ledger vorhandenen Medikamente ab.                                                                                                                                                                                                                                                                                                                                                    | `{"function":"queryAllMedikamente","Args":[]}`                                                                                                                                               |
|           | `queryMedikamenteByBezeichnung`| Abrufen| Sucht Medikamente anhand eines Teils ihrer Bezeichnung (case-insensitive, unter Verwendung eines regulären Ausdrucks). Für diese Abfrage wird ein CouchDB-Index benötigt.                                                                                                                                                                                                                                | `{"function":"queryMedikamenteByBezeichnung","Args":["Aspirin"]}`                                                                                                                            |
|           | `queryChargeCountsByMedId`| Abrufen    | Ruft die Anzahl der vorhandenen Units pro Charge für ein bestimmtes Medikament ab. Gibt eine Map zurück, deren Schlüssel die Chargenbezeichnung und deren Wert die Menge der Units ist.                                                                                                                                                                                                                | `{"function":"queryChargeCountsByMedId","Args":["MED-abc..."]}`                                                                                                                              |
| **Einheiten**| `createUnits`        | Schreiben     | Erstellt eine angegebene Anzahl (X) von Einheiten für ein *freigegebenes* Medikament. Jede Einheit erhält eine eindeutige ID und wird dem aufrufenden Hersteller als initialem Eigentümer zugewiesen. **Autorisierung:** Nur der `hersteller` des entsprechenden Medikaments ist berechtigt. Das Medikament muss den Status "freigegeben" haben.                                       | `{"function":"createUnits","Args":["MED-abc...","CH-2025-07","100","QmUnits..."]}`                                                                                                         |
|           | `addTemperatureReading`| Schreiben     | Fügt einer spezifischen Einheit einen Temperaturmesswert und dessen Zeitstempel hinzu. Dies wird zur Dokumentation der Lagerbedingungen verwendet. **Autorisierung:** Nur der aktuelle Eigentümer der Einheit ist berechtigt, Temperaturdaten hinzuzufügen.                                                                                                                                            | `{"function":"addTemperatureReading","Args":["UNIT-xyz...","5.5","2025-07-12T10:00:00Z"]}`                                                                                                    |
|           | `transferUnit`       | Schreiben     | Überträgt den Besitz einer einzelnen Einheit an einen neuen Akteur. Der neue Eigentümer muss bereits im Ledger existieren. Ein Transfer-Eintrag wird in der Historie der Einheit vermerkt. **Autorisierung:** Nur der aktuelle Eigentümer der Einheit ist berechtigt, den Besitz zu übertragen.                                                                                              | `{"function":"transferUnit","Args":["UNIT-xyz...","apotheke-123","2025-07-12T11:00:00Z"]}`                                                                                                    |
|           | `transferUnitRange`  | Schreiben     | Überträgt einen definierten Bereich von Einheiten innerhalb derselben Charge an einen neuen Besitzer. Dies ist effizient für den Transfer großer Mengen. **Autorisierung:** Der aufrufende Akteur muss der aktuelle Eigentümer aller Einheiten im angegebenen Bereich sein. Der neue Eigentümer muss existieren.                                                                               | `{"function":"transferUnitRange","Args":["MED-abc...","CH-2025-07","1","50","grosshaendler-456","2025-07-12T12:00:00Z"]}`                                                                   |
|           | `deleteUnits`        | Schreiben     | Löscht eine Liste von Units anhand ihrer IDs. Alle Units müssen dem aufrufenden Akteur gehören, sonst wird die Transaktion abgebrochen. **Autorisierung:** Nur der aktuelle Eigentümer der jeweiligen Einheiten ist berechtigt, diese zu löschen.                                                                                                                                              | `{"function":"deleteUnits","Args":["[\"UNIT-001\",\"UNIT-002\"]"]}`                                                                                                                           |
|           | `queryUnitById`      | Abrufen       | Fragt die Daten einer einzelnen Einheit anhand ihrer UnitID ab.                                                                                                                                                                                                                                                                                                                                     | `{"function":"queryUnitById","Args":["UNIT-xyz..."]}`                                                                                                                                        |
|           | `queryUnitsByMedId`  | Abrufen       | Fragt alle Einheiten ab, die zu einem bestimmten Medikament gehören.                                                                                                                                                                                                                                                                                                                                | `{"function":"queryUnitsByMedId","Args":["MED-abc..."]}`                                                                                                                                     |
|           | `queryUnitsByOwner`  | Abrufen       | Fragt alle Einheiten ab, deren aktueller Eigentümer ein bestimmter Akteur ist.                                                                                                                                                                                                                                                                                                                     | `{"function":"queryUnitsByOwner","Args":["hersteller-xyz..."]}`                                                                                                                              |